local a=component.proxy(component.list("gpu",true)())a.bind((component.list("screen",true)()))local md=a.maxDepth()local b={colors={blue=md>1 and 0x0000FF or 0,lightblue=md > 1 and 0x00CCFF or 0xFFFFFF}}local c,d=1,1;local e,f=a.maxResolution()function b.size(g,h)if g and h then e,f=g,h;a.setResolution(g,h)else return a.getResolution()end end;function b.cursor(i,j)if i and j then c,d=i,j else return c,d end end;function b.fg(k)if k then a.setForeground(k)else return a.getForeground()end end;function b.bg(l)if l then a.setBackground(l)else return a.getForeground()end end;function b.clear()a.fill(1,1,e,f," ")end;local function m()if c<1 then c=1 end;if d<1 then d=1 end;if c>e then c=e end;if d>f then a.copy(1,1,e,f,0,-1)a.fill(1,f,e,1," ")d=f end end;function b.write(n)for o in n:gmatch(".")do if o=="\n"then c,d=1,d+1;m()else a.set(c,d,o)c=c+1;m()end end end;function b.read(p,l)local q=""local r,s=p or c,l or d;local function t()c,d=r,s;b.write(q.."_ ")end;while true do t()local u,v,w,x=computer.pullSignal()if u=="key_down"then if w>31 and w<127 then q=q..string.char(w)elseif w==8 then q=q:sub(1,-2)elseif w==13 then c,d=r,s;b.write(q.." \n")return q end end end end;_G.fcons={}fcons.term=b;fcons.env=setmetatable({},{__index=_G})fcons.env.fcons=fcons;function fcons.env.load()if not component.list("eeprom",true)()then return end;local y=component.proxy(component.list("eeprom",true)()).get()local z;fcons.env.loaded,z=load(y,"=cart","bt")if not fcons.env.loaded then b.write("ERR: "..tostring(z).."\n")end;fcons.env.program=y end;function fcons.env.list()b.write((fcons.env.program or"").."\n")end;function fcons.env.run()local A,z=pcall(fcons.env.loaded)if not A and z then b.write("ERR: "..tostring(z).."\n")end end;fcons.global=_G;function fcons.env.edit()local B={}local C={i=function(D)D=tonumber(D)or 0;while true do D=D+1;local E=fcons.term.read()if E=="."then break end;if#B==0 or#B<=D then table.insert(B,E or"")else table.insert(B,D,E or"")end end end,d=function(F,G)F,G=tonumber(F),tonumber(G)G=G or 1;if not F then error("expected (number[, number])",0)end;for H=F,F+G,1 do table.remove(B,F)end end,l=function()fcons.env.load()if fcons.env.loaded then local D=""B={}for w in fcons.env.program:gmatch(".")do if w=="\n"then table.insert(B,D)D=""else D=D..w end end;if#D>0 then table.insert(B,D)end end end,s=function()component.proxy(component.list("eeprom",true)()).set(table.concat(B,"\n"))end,p=function()for i=1,#B do fcons.term.write(tostring(i).." "..B[i].."\n")end end}local function I(J)local g={}for K in J:gmatch("[^ ]+")do g[#g+1]=K end;return g end;fcons.term.clear()fcons.term.cursor(1,1)fcons.term.write("*** FCONS Editor ***\n")fcons.term.write("\ni=insert;d=delete;l=load;s=save;p=print;q=quit\n")while true do fcons.term.write("\n* ")local L=fcons.term.read()local M=I(L)if C[M[1]]then local A,z=pcall(C[M[1]],table.unpack(M,2))if not A and z then fcons.term.write("ERR: "..tostring(z).."\n")end elseif M[1]=="q"then break else fcons.term.write("?")end end;fcons.term.clear()fcons.term.cursor(0,1)end;function fcons.sprite(w,h)return a.allocateBuffer(w,h)end;function fcons.drawSprite(n,x,y)a.setActiveBuffer(n)a.bitblt(0,x,y)end;function fcons.setSprite(n)a.setActiveBuffer(n)end;b.fg(b.colors.lightblue)b.bg(b.colors.blue)b.clear()b.write("**** FCONS on ".._VERSION.." ****\n\n")b.write(string.format("RAM: %d bytes free of %d\n\n",computer.freeMemory(),computer.totalMemory()))while true do b.write("\nReady.\n")local E=b.read()local A,z=load(E,"=uinput","bt",fcons.env)if not A then b.write("ERR: "..tostring(z).."\n")else local A,z=pcall(A)if not A then b.write("ERR: "..tostring(z).."\n")end end end
